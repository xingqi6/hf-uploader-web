<!-- templates/index.html (V42.0) -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HF Uploader v42.0</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-box { height: 450px; overflow-y: scroll; background: #1e1e1e; color: #00ff00; padding: 10px; font-family: 'Consolas', monospace; font-size: 13px; border-radius: 5px; }
        .card-header { font-weight: bold; background-color: #f0f2f5; }
        .btn-action { width: 100%; font-weight: bold; padding: 10px; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-6 mb-3 mb-md-0">
            <h2>ğŸš€ HF Uploader <span class="fs-6 text-muted">v42.0</span> <span id="status-badge" class="badge bg-secondary">åŠ è½½ä¸­...</span></h2>
        </div>
        <div class="col-md-6">
            <div class="row g-2">
                <div class="col-6 col-md-3"><a href="/help" target="_blank" class="btn btn-info text-white btn-action">ğŸ“– æ•™ç¨‹</a></div>
                <div class="col-6 col-md-3"><button id="btn-reset" class="btn btn-warning btn-action" onclick="resetConfig()">ğŸ—‘ï¸ é‡ç½®</button></div>
                <div class="col-6 col-md-3"><button id="btn-start" class="btn btn-success btn-action" onclick="start()">â–¶ å¯åŠ¨</button></div>
                <div class="col-6 col-md-3"><button id="btn-stop" class="btn btn-danger btn-action" onclick="stop()">â¹ åœæ­¢</button></div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- å·¦ä¾§é…ç½® -->
        <div class="col-md-7">
            <div class="card mb-3 shadow-sm">
                <div class="card-header">ğŸ› ï¸ æ ¸å¿ƒé…ç½®</div>
                <div class="card-body">
                    <form id="main-form">
                        <div class="mb-2">
                            <label class="form-label">HF æ¥å£åœ°å€ <span class="text-danger">*</span></label>
                            <select class="form-select autosave" name="hf_endpoint">
                                <option value="https://hf-mirror.com">å›½å†…é•œåƒ (hf-mirror.com) - æ¨è</option>
                                <option value="https://huggingface.co">å®˜æ–¹åŸç‰ˆ (huggingface.co) - éœ€ä»£ç†</option>
                            </select>
                        </div>
                        <div class="row mb-2">
                            <div class="col">
                                <label class="form-label">HF Token <span class="text-danger">*</span></label>
                                <input type="password" class="form-control autosave" name="hf_token" placeholder="è¾“å…¥ hf_ å¼€å¤´çš„ Write Token" value="{{ config.hf_token }}">
                            </div>
                            <div class="col">
                                <label class="form-label">ä»“åº“ ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control autosave" name="repo_id" placeholder="ä¾‹å¦‚: zgl668/music" value="{{ config.repo_id }}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col">
                                <label class="form-label">ä»“åº“ç›®å½• (ç•™ç©ºä¸ºæ ¹ç›®å½•)</label>
                                <input type="text" class="form-control autosave" name="remote_folder" placeholder="ä¾‹å¦‚: å‘¨æ°ä¼¦" value="{{ config.remote_folder }}">
                            </div>
                            <div class="col">
                                <label class="form-label">ä»“åº“ç±»å‹</label>
                                <select class="form-select autosave" name="repo_type">
                                    <option value="dataset">Dataset (æ•°æ®é›†)</option>
                                    <option value="model">Model (æ¨¡å‹)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input autosave" type="checkbox" id="delSwitch" {% if config.delete_after_upload %}checked{% endif %}>
                            <label class="form-check-label text-danger fw-bold" for="delSwitch">ä¸Šä¼ æˆåŠŸåç«‹å³ç‰©ç†åˆ é™¤æœ¬åœ°æ–‡ä»¶ (é˜…åå³ç„š)</label>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mb-3 shadow-sm">
                <div class="card-header">ğŸ“§ é‚®ä»¶é€šçŸ¥ (å¯é€‰)</div>
                <div class="card-body">
                    <form id="email-form">
                        <div class="mb-3">
                            <label class="form-label text-primary">âœ¨ å¿«é€Ÿé€‰æ‹©é‚®ç®± (è‡ªåŠ¨å¡«åœ°å€å’Œç«¯å£)</label>
                            <select class="form-select" id="email_preset" onchange="applyPreset()">
                                <option value="">-- è¯·é€‰æ‹© --</option>
                                <option value="qq">QQ é‚®ç®±</option>
                                <option value="163">ç½‘æ˜“ 163</option>
                                <option value="gmail">Gmail</option>
                                <option value="outlook">Outlook</option>
                            </select>
                        </div>
                        <div class="row mb-2">
                            <div class="col"><input type="text" class="form-control autosave" id="input_host" placeholder="SMTPåœ°å€" name="email_host" value="{{ config.email_host }}"></div>
                            <div class="col"><input type="number" class="form-control autosave" id="input_port" placeholder="ç«¯å£" name="email_port" value="{{ config.email_port }}"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col"><input type="text" class="form-control autosave" placeholder="å‘ä»¶äººé‚®ç®±" name="email_user" value="{{ config.email_user }}"></div>
                            <div class="col"><input type="password" class="form-control autosave" placeholder="æˆæƒç  (éå¯†ç )" name="email_pass" value="{{ config.email_pass }}"></div>
                        </div>
                        <div><input type="text" class="form-control autosave" placeholder="æ”¶ä»¶äººé‚®ç®±" name="email_to" value="{{ config.email_to }}"></div>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">âš™ï¸ é«˜çº§ç­–ç•¥</div>
                <div class="card-body">
                    <form id="adv-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3 p-3 bg-light border rounded">
                                    <input class="form-check-input autosave" type="checkbox" id="accelSwitch" {% if config.enable_hf_transfer %}checked{% endif %}>
                                    <label class="form-check-label fw-bold text-primary" for="accelSwitch">âš¡ å¼€å¯é«˜é€Ÿä¼ è¾“</label>
                                    <div class="form-text text-muted" style="font-size: 12px;">æ˜“æŠ¥é”™ï¼Œå»ºè®®å…³é—­ä½¿ç”¨ç¨³å®šæ¨¡å¼ã€‚</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3 p-3 bg-light border rounded">
                                    <input class="form-check-input autosave" type="checkbox" id="idleMailSwitch" {% if config.enable_idle_email %}checked{% endif %}>
                                    <label class="form-check-label fw-bold text-success" for="idleMailSwitch">ğŸ“§ æ¥æ”¶ç©ºé—²æé†’é‚®ä»¶</label>
                                    <div class="form-text text-muted" style="font-size: 12px;">å¼€å¯åæ¯éš”ä¸€æ®µæ—¶é—´å‘é‚®ä»¶æé†’NASç©ºé—²ã€‚</div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col"><label>é¿éšœé—´éš”(ç§’)</label><input type="number" class="form-control autosave" name="file_interval" value="{{ config.file_interval }}"></div>
                            <div class="col"><label>é‡è¯•æ¬¡æ•°</label><input type="number" class="form-control autosave" name="max_retries" value="{{ config.max_retries }}"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col"><label>ğŸ›¡ï¸ é™æ­¢æ ¡éªŒ(ç§’)</label><input type="number" class="form-control autosave" name="stability_duration" value="{{ config.stability_duration }}" placeholder="é»˜è®¤60"></div>
                            <div class="col"><label>é€šçŸ¥é˜ˆå€¼(MB)</label><input type="number" class="form-control autosave" name="notify_min_size" value="{{ config.notify_min_size }}"></div>
                        </div>
                        <div class="row mb-2">
                             <div class="col"><label>ç©ºé—²æé†’(ç§’)</label><input type="number" class="form-control autosave" name="idle_interval" value="{{ config.idle_interval }}"></div>
                        </div>
                        <button type="button" id="btn-save" class="btn btn-primary w-100 mt-3 fw-bold btn-action" onclick="save()">ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between">
                    <span>ğŸ“¡ å®æ—¶æ—¥å¿—</span>
                    <small>Auto-scrolling</small>
                </div>
                <div class="card-body bg-dark p-0">
                    <div id="log-container" class="log-box"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const presets = {
        'qq': {host: 'smtp.qq.com', port: 465},
        '163': {host: 'smtp.163.com', port: 465},
        'gmail': {host: 'smtp.gmail.com', port: 465},
        'outlook': {host: 'smtp-mail.outlook.com', port: 587}
    };

    function applyPreset() {
        const val = document.getElementById('email_preset').value;
        if(presets[val]) {
            const hostInput = document.getElementById('input_host');
            const portInput = document.getElementById('input_port');
            hostInput.value = presets[val].host;
            portInput.value = presets[val].port;
            hostInput.dispatchEvent(new Event('input'));
            portInput.dispatchEvent(new Event('input'));
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        const inputs = document.querySelectorAll('.autosave');
        inputs.forEach(input => {
            const key = "hf_v42_" + input.name;
            if (!input.value && input.type !== 'checkbox') {
                const cached = localStorage.getItem(key);
                if (cached) input.value = cached;
            }
            input.addEventListener('input', function() { localStorage.setItem(key, input.value); });
            if (input.tagName === 'SELECT') {
                const cached = localStorage.getItem(key);
                if (cached) input.value = cached;
                input.addEventListener('change', function() { localStorage.setItem(key, input.value); });
            }
            if (input.type === 'checkbox') {
                const cached = localStorage.getItem(key);
                if (cached !== null) input.checked = (cached === 'true');
                input.addEventListener('change', function() { localStorage.setItem(key, input.checked); });
            }
        });
    });

    let isRunning = {{ 'true' if is_running else 'false' }};
    updateStatus(isRunning);

    function updateStatus(running) {
        const badge = document.getElementById('status-badge');
        const startBtn = document.getElementById('btn-start');
        const stopBtn = document.getElementById('btn-stop');
        const resetBtn = document.getElementById('btn-reset');
        
        if(running) {
            badge.className = "badge bg-success"; badge.innerText = "è¿è¡Œä¸­";
            startBtn.disabled = true; stopBtn.disabled = false; resetBtn.disabled = true;
        } else {
            badge.className = "badge bg-secondary"; badge.innerText = "å·²åœæ­¢";
            startBtn.disabled = false; stopBtn.disabled = true; resetBtn.disabled = false;
        }
    }

    function resetConfig() {
        if(confirm("âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é…ç½®å—ï¼Ÿ")) {
            localStorage.clear();
            fetch('/reset', {method: 'POST'}).then(r => r.json()).then(d => {
                alert(d.msg);
                location.reload();
            });
        }
    }

    function getFormData() {
        const forms = ['main-form', 'email-form', 'adv-form'];
        let data = {};
        forms.forEach(id => {
            const formEl = document.getElementById(id);
            if(formEl) {
                const formData = new FormData(formEl);
                formData.forEach((value, key) => data[key] = value);
            }
        });
        data['delete_after_upload'] = document.getElementById('delSwitch').checked;
        data['enable_hf_transfer'] = document.getElementById('accelSwitch').checked;
        data['enable_idle_email'] = document.getElementById('idleMailSwitch').checked;
        return data;
    }

    function save() {
        const btn = document.getElementById('btn-save');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "âŒ› ä¿å­˜ä¸­...";

        fetch('/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(getFormData())
        })
        .then(r => r.json())
        .then(d => {
            btn.disabled = false;
            btn.innerText = originalText;
            if(d.status === 'success') {
                alert(d.msg);
                document.querySelectorAll('.autosave').forEach(input => {
                    const key = "hf_v42_" + input.name;
                    if(input.type === 'checkbox') localStorage.setItem(key, input.checked);
                    else localStorage.setItem(key, input.value);
                });
            } else {
                alert("é”™è¯¯: " + d.msg);
            }
        })
        .catch(err => {
            btn.disabled = false;
            btn.innerText = originalText;
            alert("ç½‘ç»œé”™è¯¯: " + err);
        });
    }

    function start() {
        fetch('/start', {method: 'POST'}).then(r => r.json()).then(d => {
            if(d.status === 'success') { updateStatus(true); alert(d.msg); }
            else { alert(d.msg); updateStatus(false); }
        });
    }

    function stop() {
        fetch('/stop', {method: 'POST'}).then(r => r.json()).then(d => {
            alert(d.msg); setTimeout(() => updateStatus(false), 2000);
        });
    }

    const evtSource = new EventSource("/logs");
    const logBox = document.getElementById("log-container");
    evtSource.onmessage = function(e) {
        if(e.data.trim() !== "") {
            const div = document.createElement("div");
            div.textContent = e.data;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
        }
    };
</script>
</body>
</html>
